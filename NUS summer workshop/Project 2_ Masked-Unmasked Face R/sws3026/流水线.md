# 流水线

### 无口罩数据 - 无口罩人 / 有口罩数据 - 有口罩人 (Expert T2, T3)

- **训练**
  1. 通过dlib识别特征点 / 旋转, 裁剪图片, 提取150x150脸部图片
  2. *预处理*. 使用灰度准确度大约降低8%, 但速度会有所提升
  3. 获取数据矩阵 $X$和标签$\vec y$
  4. PCA $X=U\Sigma V^T$
  5. 获取$V^T$, 使用$V^T$和$\vec y$训练SVM
- **检测**
  1. 通过dlib识别特征点 / 旋转, 裁剪图片, 提取150x150脸部图片$X'$
  2. *预处理*
  3. 通过$V^T=\Sigma^{-1}U^TX'$获取$V^T$
  4. $V^T$喂SVM, 得结果
  5. 根据结果置信度决定是否属于类

### 无 / 有口罩数据 - 有口罩人 (Expert T3)

- **训练**

  1. 通过dlib识别特征点 / 旋转, 裁剪无口罩图片, 提取150x150脸部图片

  2. *预处理*

  3. 获取数据矩阵 $X$和标签$\vec y$

  4. PCA $X=U\Sigma V^T$

  5. 对有口罩图片$X_m$, 将其分解到 $U$上

     1. 我们不希望特征脸去拟合口罩部分, 只让合成之后其他部分尽可能接近$X_m$, 那么模型就会根据最大似然猜出口罩下面应该是怎样. 设定权重$W$让口罩部分在奇异值分解时不重要, 这个权重和每个戴口罩脸口罩位置有关.
     2. 因此, 一个思想就是删掉特征脸和有口罩人脸不重要的维度, 然后再做点积计算脸在特征脸上的投影. 但此时, 特征脸不再正交, $U^TU\neq I$, 重新合成$X_m$时不成立. 或者这个过程相当于用特征脸去模拟一个口罩部分是黑色 (乘以权重0相当于黑色) 的脸, 显然权重没有起到对应的作用
     3. 于是需要把脸分解到不正交的基上, 或者将基正交化. 由于正交化花费时间过长 (不想做), 故采用前者.
     4. 由于第一个特征脸对应奇异值最大, 之后一次递减, 自然想到贪心法, 能分解给第一个向量的就不分解给第二个.步骤
        1. 对于带口罩的脸$\vec x$, 计算其在被权重$M$遮罩过的特征脸$M\vec f_i$上的投影长度 $p_i={\left<\vec x, \vec f_i\right>\over\|\vec f_i\|}$, 
        2. 从$\vec x$中减去这个成分: $\vec x := \vec x - p_iM\vec f_i$
        3. 由于$v$要乘以对应的奇异值再乘以特征脸才能成分, 此时对应的$v$要从$p$除以对应的奇异值$v_i:=\frac {p_i}{\sigma_i}$
        4. 计算下一张特征脸的成分, $i:= i + 1$, 回到1

     > 此方法效果明显, 下图中图1为原图, 图2为贪心分解, 图3为直接分解, 均为提取50个特征脸
     >
     > ![Screen Shot 2022-07-25 at 17.48.20](流水线.assets/Screen Shot 2022-07-25 at 17.48.20.png)![Screen Shot 2022-07-25 at 17.02.30](流水线.assets/Screen Shot 2022-07-25 at 17.02.30-8742971.png)
     >
     > 其更好的保留了眼部信息, 噪声更少. 使用此方法的串联svm的准确率约为0.81, 若直接分解, 准确率约为0.68. 若直接对口罩数据进行SVD分解串联SVM, 其准确度约为0.73. 但其速度会大幅弱于直接分解的结果, 由于每个特征脸的成分依赖于上一张, 此方法多出特征脸个数倍的处理时间.
     >
     > 同时, 此方法得出合成脸和原始无口罩脸更加接近, 可以直接用其数据喂在无口罩脸上训练的SVM, 准确度约0.78; 若直接分解, 准确度仅为0.03
     
  6. 用分解得到的$V_m^T$和$\vec y$ 训练SVM

- **检测**

  1. 通过dlib识别特征点 / 旋转, 裁剪图片, 提取150x150脸部图片$X'$
  2. *预处理*
  3. 通过如上的分解方法获得$V^T$
  4. $V^T$喂SVM, 得结果
  5. 根据结果置信度决定是否属于类

### 无口罩数据 - 有口罩人 (Bonus)

#### 方法1: 直接在图片上使用dlib加上口罩, 之后方法同Expert T3.

#### 方法2

- **训练**
  1. 通过dlib识别特征点 / 旋转, 裁剪图片, 提取150x150脸部图片
  2. *预处理*
  3. 获取数据矩阵 $X$和标签$\vec y$
  4. PCA $X=U\Sigma V^T$
  5. 获取$V$, 使用$V$和$\vec y$训练SVM
- **检测**
  1. 通过dlib识别特征点 / 旋转, 裁剪图片, 提取150x150脸部图片$X'$
  2. *预处理*
  3. 通过如上的分解方法获得$V^T$
  4. $V^T$喂SVM, 得结果



**EMERALD** **E**igenface **M**odel with **E**xtendable, **R**obust **L**eft-singular-vector **D**ecomposition

**EMINEM** **E**MINEM **M**odel **I**s **N**ot just an **E**igenface **M**odel





